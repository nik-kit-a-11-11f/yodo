-- База данных для интернет-магазина "ТехноСфера"
-- Удаляем базу если существует и создаем заново
DROP DATABASE IF EXISTS technosfera_db;
CREATE DATABASE technosfera_db;
USE technosfera_db;

-- Таблица пользователей
CREATE TABLE users (
    user_id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    phone VARCHAR(20),
    address TEXT,
    role ENUM('customer', 'admin', 'manager') DEFAULT 'customer',
    registration_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP NULL,
    is_active BOOLEAN DEFAULT TRUE
);

-- Таблица категорий товаров
CREATE TABLE categories (
    category_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    parent_id INT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    image_url VARCHAR(255),
    sort_order INT DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (parent_id) REFERENCES categories(category_id) ON DELETE SET NULL
);

-- Таблица товаров
CREATE TABLE products (
    product_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    short_description VARCHAR(500),
    price DECIMAL(10,2) NOT NULL,
    old_price DECIMAL(10,2) NULL,
    sku VARCHAR(100) UNIQUE NOT NULL,
    stock_quantity INT DEFAULT 0,
    category_id INT,
    images JSON, -- JSON массив с путями к изображениям
    specifications JSON, -- JSON с характеристиками товара
    weight DECIMAL(8,2) NULL,
    dimensions VARCHAR(50) NULL,
    is_featured BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    views_count INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (category_id) REFERENCES categories(category_id) ON DELETE SET NULL
);

-- Таблица заказов
CREATE TABLE orders (
    order_id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT,
    order_number VARCHAR(50) UNIQUE NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    status ENUM('pending', 'processing', 'shipped', 'delivered', 'cancelled') DEFAULT 'pending',
    payment_method ENUM('card', 'cash', 'online') DEFAULT 'card',
    payment_status ENUM('pending', 'paid', 'failed', 'refunded') DEFAULT 'pending',
    shipping_address TEXT NOT NULL,
    billing_address TEXT NOT NULL,
    customer_notes TEXT,
    admin_notes TEXT,
    tracking_number VARCHAR(100),
    shipping_cost DECIMAL(8,2) DEFAULT 0,
    tax_amount DECIMAL(8,2) DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE SET NULL
);

-- Таблица элементов заказа
CREATE TABLE order_items (
    order_item_id INT PRIMARY KEY AUTO_INCREMENT,
    order_id INT,
    product_id INT,
    product_name VARCHAR(255) NOT NULL, -- Сохраняем название на момент заказа
    product_price DECIMAL(10,2) NOT NULL, -- Сохраняем цену на момент заказа
    quantity INT NOT NULL,
    total_price DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (order_id) REFERENCES orders(order_id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(product_id) ON DELETE SET NULL
);

-- Таблица отзывов о товарах
CREATE TABLE reviews (
    review_id INT PRIMARY KEY AUTO_INCREMENT,
    product_id INT,
    user_id INT,
    rating TINYINT NOT NULL CHECK (rating >= 1 AND rating <= 5),
    title VARCHAR(255),
    comment TEXT,
    is_approved BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (product_id) REFERENCES products(product_id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);

-- Таблица корзины покупок
CREATE TABLE cart (
    cart_id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT,
    product_id INT,
    quantity INT NOT NULL DEFAULT 1,
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(product_id) ON DELETE CASCADE,
    UNIQUE KEY unique_user_product (user_id, product_id)
);

-- Таблица избранных товаров
CREATE TABLE wishlist (
    wishlist_id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT,
    product_id INT,
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES products(product_id) ON DELETE CASCADE,
    UNIQUE KEY unique_user_product_wishlist (user_id, product_id)
);

-- Заполняем таблицу пользователей
INSERT INTO users (username, email, password_hash, first_name, last_name, phone, address, role) VALUES
('admin', 'admin@technosfera.ru', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'Администратор', 'Системы', '+7-495-123-45-67', 'Москва, ул. Тверская, д. 1', 'admin'),
('ivanov', 'ivan@mail.ru', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'Иван', 'Петров', '+7-901-111-2233', 'Москва, ул. Ленина, д. 10, кв. 5', 'customer'),
('sidorova', 'sidorova@mail.ru', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'Мария', 'Сидорова', '+7-902-222-3344', 'Москва, пр. Мира, д. 25, кв. 12', 'customer'),
('manager1', 'manager@technosfera.ru', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'Алексей', 'Менеджеров', '+7-495-765-43-21', 'Москва, ул. Профсоюзная, д. 15', 'manager');

-- Заполняем таблицу категорий
INSERT INTO categories (name, description, parent_id, slug, sort_order) VALUES
('Электроника', 'Современная электроника и гаджеты', NULL, 'electronics', 1),
('Ноутбуки и компьютеры', 'Ноутбуки, ПК, моноблоки и аксессуары', 1, 'laptops-computers', 2),
('Смартфоны и планшеты', 'Мобильные устройства и аксессуары', 1, 'smartphones-tablets', 3),
('Аудиотехника', 'Наушники, колонки и аудиосистемы', 1, 'audio', 4),
('Телевизоры и видео', 'Телевизоры, проекторы и медиаплееры', 1, 'tv-video', 5),
('Игровые консоли', 'Игровые приставки и аксессуары', NULL, 'gaming', 6),
('Бытовая техника', 'Техника для дома и кухни', NULL, 'home-appliances', 7);

-- Заполняем таблицу товаров
INSERT INTO products (name, description, short_description, price, old_price, sku, stock_quantity, category_id, specifications) VALUES
('Ноутбук Dell XPS 13', 'Ультрабук с безрамочным дисплеем InfinityEdge, процессором Intel Core i7 и SSD на 512 ГБ.', 'Мощный ультрабук для работы и творчества', 89999.00, 94999.00, 'DELL-XPS13-2023', 15, 2, 
 '{"processor": "Intel Core i7-1165G7", "ram": "16 ГБ", "storage": "512 ГБ SSD", "display": "13.4\\" FHD+", "graphics": "Intel Iris Xe", "os": "Windows 11"}'),

('iPhone 15 Pro 256GB', 'Флагманский смартфон Apple с процессором A17 Pro, камерой 48 МП и титановым корпусом.', 'Флагман Apple с инновационной камерой', 99999.00, NULL, 'APPLE-IP15PRO-256', 8, 3,
 '{"display": "6.1\\" Super Retina XDR", "processor": "Apple A17 Pro", "storage": "256 ГБ", "camera": "48 МП + 12 МП + 12 МП", "battery": "3274 mAh", "os": "iOS 17"}'),

('Наушники Sony WH-1000XM5', 'Беспроводные наушники с шумоподавлением и автономностью до 30 часов.', 'Премиальные наушники с шумоподавлением', 29999.00, 32999.00, 'SONY-WH1000XM5', 25, 4,
 '{"type": "Накладные беспроводные", "battery": "30 часов", "noise_canceling": "Активное", "connection": "Bluetooth 5.2", "weight": "250 г"}'),

('Samsung Galaxy S23 Ultra', 'Смартфон с S-Pen, камерой 200 МП и процессором Snapdragon 8 Gen 2.', 'Мощный смартфон с S-Pen для продуктивности', 84999.00, 89999.00, 'SAMSUNG-S23ULTRA-256', 12, 3,
 '{"display": "6.8\\" Dynamic AMOLED", "processor": "Snapdragon 8 Gen 2", "storage": "256 ГБ", "camera": "200 МП + 10 МП + 10 МП + 12 МП", "battery": "5000 mAh", "os": "Android 13"}'),

('PlayStation 5', 'Игровая консоль нового поколения с поддержкой 4K и 120 FPS.', 'Игровая консоль следующего поколения', 49999.00, 54999.00, 'SONY-PS5-STD', 5, 6,
 '{"processor": "AMD Ryzen Zen 2", "graphics": "AMD RDNA 2", "storage": "825 ГБ SSD", "resolution": "4K 120Hz", "features": "Ray Tracing, 3D Audio"}'),

('MacBook Air M2', 'Ультрабук Apple с чипом M2, дисплеем Liquid Retina и автономностью до 18 часов.', 'Легкий и мощный MacBook с чипом M2', 119999.00, NULL, 'APPLE-MBA-M2-512', 10, 2,
 '{"processor": "Apple M2", "ram": "8 ГБ", "storage": "512 ГБ SSD", "display": "13.6\\" Liquid Retina", "battery": "18 часов", "os": "macOS Ventura"}'),

('Телевизор LG OLED C3', 'OLED телевизор с поддержкой Dolby Vision, 120 Гц и технологией AI Sound Pro.', 'Премиальный OLED телевизор с идеальным черным', 129999.00, 139999.00, 'LG-OLED55C3', 7, 5,
 '{"display": "55\\" OLED", "resolution": "4K", "refresh_rate": "120 Гц", "hdr": "Dolby Vision, HDR10", "smart_tv": "webOS", "hdmi": "4 порта"}'),

('Кофемашина DeLonghi Magnifica', 'Автоматическая кофемашина с функцией приготовления капучино и помолом зерен.', 'Профессиональная кофемашина для дома', 44999.00, 49999.00, 'DELONGHI-MAGNIFICA', 18, 7,
 '{"type": "Автоматическая", "water_tank": "1.8 л", "bean_container": "250 г", "functions": "Капучино, эспрессо, латте", "power": "1450 Вт"}');

-- Заполняем таблицу заказов
INSERT INTO orders (user_id, order_number, total_amount, status, payment_method, payment_status, shipping_address, billing_address) VALUES
(2, 'TS-2023-001', 129998.00, 'delivered', 'card', 'paid', 'Москва, ул. Ленина, д. 10, кв. 5', 'Москва, ул. Ленина, д. 10, кв. 5'),
(3, 'TS-2023-002', 29999.00, 'shipped', 'online', 'paid', 'Москва, пр. Мира, д. 25, кв. 12', 'Москва, пр. Мира, д. 25, кв. 12'),
(2, 'TS-2023-003', 49999.00, 'processing', 'card', 'paid', 'Москва, ул. Ленина, д. 10, кв. 5', 'Москва, ул. Ленина, д. 10, кв. 5');

-- Заполняем таблицу элементов заказа
INSERT INTO order_items (order_id, product_id, product_name, product_price, quantity, total_price) VALUES
(1, 1, 'Ноутбук Dell XPS 13', 89999.00, 1, 89999.00),
(1, 3, 'Наушники Sony WH-1000XM5', 29999.00, 1, 29999.00),
(1, 8, 'Кофемашина DeLonghi Magnifica', 44999.00, 1, 44999.00),
(2, 3, 'Наушники Sony WH-1000XM5', 29999.00, 1, 29999.00),
(3, 5, 'PlayStation 5', 49999.00, 1, 49999.00);

-- Заполняем таблицу отзывов
INSERT INTO reviews (product_id, user_id, rating, title, comment, is_approved) VALUES
(1, 2, 5, 'Отличный ноутбук!', 'Пользуюсь уже месяц - прекрасная производительность, легкий и стильный. Батарея держит целый рабочий день.', TRUE),
(3, 3, 4, 'Хорошие наушники', 'Шумоподавление работает отлично, звук чистый. Немного тяжеловаты для длительного ношения.', TRUE),
(5, 2, 5, 'Мечта геймера', 'PS5 превосходит все ожидания! Графика нереальная, загрузки мгновенные. Рекомендую всем геймерам.', TRUE);

-- Заполняем таблицу корзины
INSERT INTO cart (user_id, product_id, quantity) VALUES
(2, 4, 1),
(2, 7, 1),
(3, 6, 1);

-- Заполняем таблицу избранного
INSERT INTO wishlist (user_id, product_id) VALUES
(2, 2),
(2, 6),
(3, 1),
(3, 4);

-- Создаем представления для удобства
CREATE VIEW product_catalog AS
SELECT 
    p.product_id,
    p.name,
    p.short_description,
    p.description,
    p.price,
    p.old_price,
    p.sku,
    p.stock_quantity,
    c.name as category_name,
    c.category_id,
    p.is_featured,
    p.is_active,
    p.views_count,
    p.created_at
FROM products p
LEFT JOIN categories c ON p.category_id = c.category_id
WHERE p.is_active = TRUE;

CREATE VIEW order_details AS
SELECT 
    o.order_id,
    o.order_number,
    o.total_amount,
    o.status,
    o.payment_method,
    o.payment_status,
    o.created_at,
    u.first_name,
    u.last_name,
    u.email,
    u.phone,
    COUNT(oi.order_item_id) as items_count
FROM orders o
LEFT JOIN users u ON o.user_id = u.user_id
LEFT JOIN order_items oi ON o.order_id = oi.order_id
GROUP BY o.order_id;

CREATE VIEW product_reviews_summary AS
SELECT 
    p.product_id,
    p.name as product_name,
    COUNT(r.review_id) as reviews_count,
    AVG(r.rating) as average_rating,
    MIN(r.rating) as min_rating,
    MAX(r.rating) as max_rating
FROM products p
LEFT JOIN reviews r ON p.product_id = r.product_id AND r.is_approved = TRUE
GROUP BY p.product_id;

-- Создаем индексы для улучшения производительности
CREATE INDEX idx_products_category ON products(category_id);
CREATE INDEX idx_products_active ON products(is_active);
CREATE INDEX idx_products_featured ON products(is_featured);
CREATE INDEX idx_orders_user ON orders(user_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_date ON orders(created_at);
CREATE INDEX idx_order_items_order ON order_items(order_id);
CREATE INDEX idx_order_items_product ON order_items(product_id);
CREATE INDEX idx_reviews_product ON reviews(product_id);
CREATE INDEX idx_reviews_user ON reviews(user_id);
CREATE INDEX idx_cart_user ON cart(user_id);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_categories_slug ON categories(slug);

-- Создаем пользователя для приложения
CREATE USER 'technosfera_user'@'localhost' IDENTIFIED BY 'secure_password_123';
GRANT SELECT, INSERT, UPDATE, DELETE ON technosfera_db.* TO 'technosfera_user'@'localhost';
FLUSH PRIVILEGES;

-- Выводим сообщение о успешном создании
SELECT 'База данных "ТехноСфера" успешно создана!' AS message;
SELECT 
    (SELECT COUNT(*) FROM users) AS users_count,
    (SELECT COUNT(*) FROM categories) AS categories_count,
    (SELECT COUNT(*) FROM products) AS products_count,
    (SELECT COUNT(*) FROM orders) AS orders_count,
    (SELECT COUNT(*) FROM reviews) AS reviews_count;
